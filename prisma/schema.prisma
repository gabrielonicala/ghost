generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id                String            @id @default(cuid())
  name              String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  brandDictionaries BrandDictionary[]
  campaigns         Campaign[]
  integrations      Integration[]
  users             User[]
}

model User {
  id             String       @id // Uses Supabase Auth UUID
  email          String       @unique
  name           String?
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Creator {
  id                  String                   @id @default(cuid())
  platform            String
  platformId          String
  username            String
  displayName         String?
  profileImageUrl     String?
  followerCount       Int?
  verified            Boolean                  @default(false)
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  authenticitySignals AuthenticitySignal[]
  campaigns           CampaignCreator[]
  contentItems        ContentItem[]
  creatorIdentities   CreatorIdentity[]
  promotionMetrics    PromotionDensityMetric[]

  @@unique([platform, platformId])
  @@index([platform, username])
}

model CreatorIdentity {
  id         String   @id @default(cuid())
  creatorId  String
  platform   String
  platformId String
  username   String
  verified   Boolean  @default(false)
  createdAt  DateTime @default(now())
  creator    Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([platform, platformId])
  @@index([creatorId])
}

model Campaign {
  id              String                @id @default(cuid())
  organizationId  String
  name            String
  brief           String?
  status          String                @default("draft")
  startDate       DateTime?
  endDate         DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  organization    Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creators        CampaignCreator[]
  performanceData CampaignPerformance[]
  contentItems    ContentItem[]

  @@index([organizationId, status])
}

model CampaignCreator {
  id          String    @id @default(cuid())
  campaignId  String
  creatorId   String
  status      String    @default("assigned")
  assignedAt  DateTime  @default(now())
  deliveredAt DateTime?
  campaign    Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creator     Creator   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([campaignId, creatorId])
  @@index([campaignId])
  @@index([creatorId])
}

model ContentItem {
  id                  String                     @id @default(cuid())
  creatorId           String
  campaignId          String?
  platform            String
  platformContentId   String
  contentType         String
  mediaUrl            String
  thumbnailUrl        String?
  caption             String?
  publishedAt         DateTime
  detectedAt          DateTime                   @default(now())
  ingestedAt          DateTime                   @default(now())
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  trustMetrics        AudienceTrustMetric[]
  authenticitySignals AuthenticitySignal[]
  brandDetections     BrandDetection[]
  performanceData     CampaignPerformance[]
  campaign            Campaign?                  @relation(fields: [campaignId], references: [id])
  creator             Creator                    @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  metricsSnapshots    ContentMetricsSnapshot[]
  ocrFrames           ContentOcrFrame[]
  similarityHashes    ContentSimilarityHash[]
  transcripts         ContentTranscript[]
  visualFeatures      ContentVisualFeature[]
  conversionScores    ConversionConfidenceScore?
  fatigueMetrics      UgcFatigueMetric[]

  @@unique([platform, platformContentId])
  @@index([creatorId])
  @@index([campaignId])
  @@index([publishedAt])
  @@index([detectedAt])
}

model ContentMetricsSnapshot {
  id             String      @id @default(cuid())
  contentItemId  String
  snapshotAt     DateTime    @default(now())
  views          Int?
  likes          Int?
  comments       Int?
  shares         Int?
  saves          Int?
  engagementRate Float?
  contentItem    ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@index([contentItemId, snapshotAt])
}

model ContentTranscript {
  id            String      @id @default(cuid())
  contentItemId String
  text          String
  language      String      @default("en")
  confidence    Float?
  createdAt     DateTime    @default(now())
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@index([contentItemId])
}

model ContentOcrFrame {
  id            String      @id @default(cuid())
  contentItemId String
  frameIndex    Int
  text          String
  confidence    Float?
  boundingBoxes Json?
  createdAt     DateTime    @default(now())
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@index([contentItemId])
}

model ContentVisualFeature {
  id             String      @id @default(cuid())
  contentItemId  String
  embedding      String?
  hash           String?
  dominantColors Json?
  createdAt      DateTime    @default(now())
  contentItem    ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@index([contentItemId])
}

model ContentSimilarityHash {
  id            String      @id @default(cuid())
  contentItemId String
  hashType      String
  hashValue     String
  createdAt     DateTime    @default(now())
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@index([contentItemId, hashType])
  @@index([hashValue])
}

model BrandDictionary {
  id             String           @id @default(cuid())
  organizationId String
  brandName      String
  keywords       String[]
  productNames   String[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  detections     BrandDetection[]
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model BrandDetection {
  id                String          @id @default(cuid())
  contentItemId     String
  brandDictionaryId String
  detectionMethod   String
  confidence        Float
  matchedText       String?
  matchedKeywords   String[]
  createdAt         DateTime        @default(now())
  brandDictionary   BrandDictionary @relation(fields: [brandDictionaryId], references: [id], onDelete: Cascade)
  contentItem       ContentItem     @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@index([contentItemId])
  @@index([brandDictionaryId])
  @@index([detectionMethod])
}

model AuthenticitySignal {
  id                 String       @id @default(cuid())
  contentItemId      String?
  creatorId          String?
  score              Float
  scriptLikelihood   Float?
  reusedHookDetected Boolean      @default(false)
  transcriptEntropy  Float?
  phraseReuseCount   Int?
  naturalPacingScore Float?
  brandMentionTiming Float?
  hookOriginality    Float?
  visualContinuity   Float?
  reasonBreakdown    Json?
  computedAt         DateTime     @default(now())
  contentItem        ContentItem? @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  creator            Creator?     @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([contentItemId])
  @@index([creatorId])
  @@index([computedAt])
}

model AudienceTrustMetric {
  id                       String      @id @default(cuid())
  contentItemId            String
  trustIndex               Float
  engagementQualityGrade   String?
  purchaseIntentConfidence Float?
  commentSentimentPolarity Float?
  questionDensity          Float?
  purchaseIntentKeywords   Int?
  repeatCommenterFrequency Float?
  saveToViewRatio          Float?
  replyDepthAverage        Float?
  emojiToTextRatio         Float?
  computedAt               DateTime    @default(now())
  contentItem              ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@index([contentItemId])
  @@index([computedAt])
}

model PromotionDensityMetric {
  id                   String   @id @default(cuid())
  creatorId            String
  periodDays           Int
  promotionalPostRatio Float
  competingBrandsCount Int?
  categoryOverlapFreq  Float?
  promotionClustering  Float?
  sponsoredSpacingAvg  Float?
  saturationRiskLevel  String?
  recommendedCooldown  Int?
  computedAt           DateTime @default(now())
  creator              Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, periodDays])
  @@index([computedAt])
}

model UgcFatigueMetric {
  id                            String      @id @default(cuid())
  contentItemId                 String
  fatigueRiskScore              Float
  creativeOriginalityPercentile Float?
  structuralSimilarity          Float?
  hookPatternReuseFreq          Float?
  visualCompositionOverlap      Float?
  audioTrendSaturation          Float?
  brandLevelRepetition          Float?
  industryLevelExhaustion       Float?
  overusedFormatWarnings        String[]
  computedAt                    DateTime    @default(now())
  contentItem                   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@index([contentItemId])
  @@index([computedAt])
}

model ConversionConfidenceScore {
  id                       String      @id @default(cuid())
  contentItemId            String      @unique
  score                    Float
  authenticityScore        Float
  audienceTrustScore       Float
  promotionSaturationScore Float
  fatigueRiskScore         Float
  predictedPerformanceTier String?
  recommendedUse           String[]
  confidenceInterval       Json?
  reasonAttribution        Json?
  computedAt               DateTime    @default(now())
  updatedAt                DateTime    @updatedAt
  contentItem              ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@index([score])
  @@index([computedAt])
}

model Integration {
  id              String                @id @default(cuid())
  organizationId  String
  type            String
  credentials     Json
  status          String                @default("active")
  lastSyncedAt    DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  performanceData CampaignPerformance[]
  organization    Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model CampaignPerformance {
  id            String       @id @default(cuid())
  campaignId    String
  integrationId String?
  contentItemId String?
  metricType    String
  value         Float
  metadata      Json?
  recordedAt    DateTime     @default(now())
  campaign      Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contentItem   ContentItem? @relation(fields: [contentItemId], references: [id])
  integration   Integration? @relation(fields: [integrationId], references: [id])

  @@index([campaignId])
  @@index([contentItemId])
  @@index([recordedAt])
}
